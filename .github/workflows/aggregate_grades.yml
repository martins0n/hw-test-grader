name: Aggregate Grades

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      assignment_id:
        description: 'Assignment ID (leave empty for all assignments)'
        required: false
        type: string

jobs:
  aggregate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: read  # Needed to download artifacts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download grading report artifacts from all workflows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSIGNMENT_ID: ${{ github.event.inputs.assignment_id }}
        run: |
          # Use GitHub CLI to download artifacts from grade_submission workflows
          echo "üîç Searching for grading report artifacts..."

          mkdir -p artifacts

          # Get all grade_submission workflow runs (completed, not just successful)
          echo "Fetching workflow runs..."
          gh run list \
            --workflow=grade_submission.yml \
            --limit=100 \
            --json databaseId,status,conclusion,createdAt \
            --jq '.[] | select(.status == "completed") | .databaseId' > workflow_runs.txt

          run_count=$(wc -l < workflow_runs.txt)
          echo "Found $run_count completed workflow run(s)"

          if [ ! -s workflow_runs.txt ]; then
            echo "‚ö†Ô∏è  No completed grade_submission workflows found"
            echo "   This might mean:"
            echo "   - No students have been graded yet"
            echo "   - The workflow name doesn't match 'grade_submission.yml'"
            echo ""
            echo "Listing all recent workflows:"
            gh run list --limit=10
            exit 0
          fi

          # Download artifacts from each workflow run
          total_count=0
          downloaded_count=0

          while read -r run_id; do
            echo ""
            echo "Checking workflow run #$run_id..."

            # List artifacts using GitHub API
            gh api "/repos/${{ github.repository }}/actions/runs/${run_id}/artifacts" \
              --jq '.artifacts[] | "\(.name)|\(.expired)"' > artifacts_list.txt 2>/dev/null || continue

            if [ ! -s artifacts_list.txt ]; then
              echo "  No artifacts found in this run"
              continue
            fi

            echo "  Artifacts in this run:"
            cat artifacts_list.txt | while IFS='|' read -r name expired; do
              echo "    - $name (expired: $expired)"
            done

            # Download grading report artifacts that haven't expired
            cat artifacts_list.txt | while IFS='|' read -r artifact_name expired; do
              if [[ "$artifact_name" == grading-report-* ]] && [ "$expired" = "false" ]; then
                echo "  üì• Downloading: $artifact_name"
                if gh run download "$run_id" --name "$artifact_name" --dir "artifacts/$artifact_name" 2>&1; then
                  echo "    ‚úì Downloaded successfully"
                  ((downloaded_count++))
                else
                  echo "    ‚ö†Ô∏è  Failed to download"
                fi
                ((total_count++))
              fi
            done
          done < workflow_runs.txt

          echo ""
          echo "============================================"
          # Count actual downloaded artifacts
          if [ -d "artifacts" ]; then
            actual_count=$(find artifacts -name "grade_report.json" 2>/dev/null | wc -l)
            echo "Found $actual_count grading report(s) in artifacts directory"
          else
            actual_count=0
            echo "No artifacts directory created"
          fi
          echo "============================================"

      - name: Check if artifacts were downloaded
        id: check-artifacts
        run: |
          if [ -d "artifacts" ] && [ "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "‚úì Found grading report artifacts"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No grading report artifacts found"
            echo "   Students need to submit and get graded before aggregation can run."
          fi

      - name: Aggregate grades into CSV
        if: steps.check-artifacts.outputs.found == 'true'
        env:
          ASSIGNMENT_ID: ${{ github.event.inputs.assignment_id }}
        run: |
          python scripts/aggregate_grades.py \
            --artifacts-dir artifacts/ \
            --output-dir reports/aggregated/ \
            ${ASSIGNMENT_ID:+--assignment-id "$ASSIGNMENT_ID"}

      - name: Upload aggregated CSVs
        if: steps.check-artifacts.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-grades-${{ github.run_number }}
          path: reports/aggregated/*.csv
          if-no-files-found: warn

      - name: Summary
        if: always()
        run: |
          echo "## Aggregation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Run at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-artifacts.outputs.found }}" = "false" ]; then
            echo "### ‚ö†Ô∏è No Grading Reports Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is normal if:" >> $GITHUB_STEP_SUMMARY
            echo "- No students have submitted yet" >> $GITHUB_STEP_SUMMARY
            echo "- No grading workflows have completed yet" >> $GITHUB_STEP_SUMMARY
            echo "- Artifacts have expired (90 days)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What to do:** Wait for students to submit and get graded, then run this workflow again." >> $GITHUB_STEP_SUMMARY
          elif [ -d reports/aggregated ]; then
            echo "### Generated CSV Files" >> $GITHUB_STEP_SUMMARY
            for csv in reports/aggregated/*.csv; do
              if [ -f "$csv" ]; then
                assignment=$(basename "$csv" .csv | sed 's/grades_//')
                count=$(tail -n +2 "$csv" | wc -l)
                echo "- **$assignment**: $count students" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "‚ö†Ô∏è No grades found to aggregate" >> $GITHUB_STEP_SUMMARY
          fi

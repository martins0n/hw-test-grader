name: Aggregate Grades

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      assignment_id:
        description: 'Assignment ID (leave empty for all assignments)'
        required: false
        type: string

  # Run daily to aggregate recent grades
  schedule:
    - cron: '0 2 * * *'  # Run at 2 AM daily

jobs:
  aggregate:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: read  # Needed to download artifacts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download grading report artifacts from all workflows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSIGNMENT_ID: ${{ github.event.inputs.assignment_id }}
        run: |
          # Use GitHub CLI to download artifacts from grade_submission workflows
          echo "üîç Searching for grading report artifacts..."

          mkdir -p artifacts

          # Get all successful grade_submission workflow runs from the last 30 days
          gh run list \
            --workflow=grade_submission.yml \
            --status=success \
            --limit=100 \
            --json databaseId,conclusion \
            --jq '.[].databaseId' > workflow_runs.txt

          if [ ! -s workflow_runs.txt ]; then
            echo "‚ö†Ô∏è  No successful grade_submission workflows found"
            exit 0
          fi

          # Download artifacts from each workflow run
          count=0
          while read -r run_id; do
            echo "Checking run #$run_id..."

            # List artifacts for this run
            gh run view "$run_id" \
              --json artifacts \
              --jq '.artifacts[] | select(.name | startswith("grading-report-")) | .name' > artifacts_list.txt || continue

            # Download each grading report artifact
            while read -r artifact_name; do
              if [ -n "$artifact_name" ]; then
                echo "  üì• Downloading: $artifact_name"
                gh run download "$run_id" \
                  --name "$artifact_name" \
                  --dir "artifacts/$artifact_name" 2>/dev/null || echo "    ‚ö†Ô∏è  Failed to download"
                ((count++))
              fi
            done < artifacts_list.txt
          done < workflow_runs.txt

          echo "‚úì Downloaded $count artifact(s)"

      - name: Check if artifacts were downloaded
        id: check-artifacts
        run: |
          if [ -d "artifacts" ] && [ "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "‚úì Found grading report artifacts"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No grading report artifacts found"
            echo "   Students need to submit and get graded before aggregation can run."
          fi

      - name: Aggregate grades into CSV
        if: steps.check-artifacts.outputs.found == 'true'
        env:
          ASSIGNMENT_ID: ${{ github.event.inputs.assignment_id }}
        run: |
          python scripts/aggregate_grades.py \
            --artifacts-dir artifacts/ \
            --output-dir reports/aggregated/ \
            ${ASSIGNMENT_ID:+--assignment-id "$ASSIGNMENT_ID"}

      - name: Upload aggregated CSVs
        if: steps.check-artifacts.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-grades-${{ github.run_number }}
          path: reports/aggregated/*.csv
          if-no-files-found: warn

      - name: Summary
        if: always()
        run: |
          echo "## Aggregation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Run at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-artifacts.outputs.found }}" = "false" ]; then
            echo "### ‚ö†Ô∏è No Grading Reports Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This is normal if:" >> $GITHUB_STEP_SUMMARY
            echo "- No students have submitted yet" >> $GITHUB_STEP_SUMMARY
            echo "- No grading workflows have completed yet" >> $GITHUB_STEP_SUMMARY
            echo "- Artifacts have expired (90 days)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What to do:** Wait for students to submit and get graded, then run this workflow again." >> $GITHUB_STEP_SUMMARY
          elif [ -d reports/aggregated ]; then
            echo "### Generated CSV Files" >> $GITHUB_STEP_SUMMARY
            for csv in reports/aggregated/*.csv; do
              if [ -f "$csv" ]; then
                assignment=$(basename "$csv" .csv | sed 's/grades_//')
                count=$(tail -n +2 "$csv" | wc -l)
                echo "- **$assignment**: $count students" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "‚ö†Ô∏è No grades found to aggregate" >> $GITHUB_STEP_SUMMARY
          fi
